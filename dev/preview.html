<html>
  <head>
    <meta charset="utf-8">
    <title>Cauliflower v0.1 - Preview</title>
    <link rel="stylesheet" href="jquery/css/jquery-ui-1.8.22.custom.css">
    <script type="text/javascript" src="jquery/jquery-1.7.2.min.js"></script>
    <script type="text/javascript" src="jquery/jquery-ui-1.8.22.custom.min.js"></script>
    <script type="text/javascript" src="jquery/jquery.cookie.js"></script>
  </head>
  <body>
    <script>
      $(document).ready(function() {
          try {
              console.log('load');
              var html = window.opener.getAllCode(true);
              var doc = window.opener.parseHTML2DOM(false);
              if (doc != null) {
                  var titles = doc.getElementsByTagName('title');
                  if (titles.length != 0) {
                      $('title').text(titles[0].firstChild.nodeValue);
                  }
              }
              
              $('#preview_contents').html(html);
          } catch (e) {
              window.close();
              window.opener.alert(e);//dialogにすること
          }
          
          /*
           もし関数外のコードを許すなら、一度実行しないと、document.writeなどが実行されない
           復活させるべきコードだと思われる。HTMLの書きだしの順番は考慮すべき。
           try {
           eval(window.opener.getJavaScriptCode());
           } catch (e) {
           alert('Program error:\n' + e);
           }*/
      });
    </script>
    <div id="preview_contents">
    </div>
  </body>
</html>
